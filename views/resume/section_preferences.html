{% extends "layouts/dashboard.html" %}

{% block content %}
<div class="max-w-7xl mx-auto">

    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <a href="/profile" class="text-gray-600 hover:text-black mb-2 inline-block">
                ← Back to Profile
            </a>
            <h1 class="text-2xl font-semibold">Section Preferences</h1>
            <p class="text-gray-600 mt-1">
                Select individual items to regenerate for each job application
            </p>
        </div>
    </div>

    <!-- Info Card -->
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
        <div class="flex gap-3">
            <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <p class="text-sm text-blue-800 font-medium mb-1">How selection works:</p>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>• Check any paragraph or bullet point to select it</li>
                    <li>• Selected items will be regenerated by AI for each job</li>
                    <li>• Unselected items remain unchanged</li>
                    <li>• You can select specific bullets within each job</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

        <!-- Left: Controls -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 sticky top-6">
                <h2 class="text-lg font-semibold mb-4">Controls</h2>

                <!-- Enable Toggle -->
                <div class="mb-6">
                    <label class="flex items-center justify-between cursor-pointer">
                        <span class="text-sm font-medium text-gray-700">Enable Selective</span>
                        <div class="relative">
                            <input type="checkbox" id="enableSelective" onchange="toggleSelective(this.checked)"
                                class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                            </div>
                        </div>
                    </label>
                </div>

                <!-- Status Display -->
                <div id="statusDisplay" class="hidden mb-6 p-3 bg-green-50 border border-green-200 rounded-md">
                    <p class="text-sm text-green-800 font-medium mb-1">
                        ✓ Selective enabled
                    </p>
                    <div class="text-xs text-green-700 space-y-1">
                        <p><span id="itemCount">0</span> items selected</p>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="space-y-3">
                    <button onclick="loadResume()"
                        class="w-full px-4 py-2 bg-black text-white rounded-md text-sm hover:bg-gray-800">
                        Load Resume Preview
                    </button>

                    <button onclick="selectAll()" id="selectAllBtn"
                        class="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-50"
                        disabled>
                        Select All
                    </button>

                    <button onclick="deselectAll()" id="deselectAllBtn"
                        class="w-full px-4 py-2 border border-gray-300 text-gray-700 rounded-md text-sm hover:bg-gray-50"
                        disabled>
                        Deselect All
                    </button>

                    <hr class="my-4">

                    <button onclick="savePreferences()" id="saveBtn"
                        class="w-full px-4 py-2 bg-green-600 text-white rounded-md text-sm hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled>
                        Save Preferences
                    </button>
                </div>
            </div>
        </div>

        <!-- Right: Resume Preview with Checkboxes -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl border border-gray-200 shadow-sm">

                <!-- Loading State -->
                <div id="resumeLoading" class="text-center py-12">
                    <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <p class="text-gray-600">Click "Load Resume Preview" to start</p>
                </div>

                <!-- Resume Preview Container -->
                <div id="resumePreview" class="hidden">
                    <div class="max-w-4xl mx-auto bg-white shadow-lg p-10 rounded-lg">
                        <div id="latex-content" class="space-y-4">
                            <!-- HTML content will be inserted here -->
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </div>

</div>

<!-- Success Modal -->
<div id="successModal" class="fixed inset-0 bg-black/30 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 text-center max-w-md">
        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h3 class="text-lg font-semibold mb-2">Preferences Saved!</h3>
        <p class="text-gray-600 mb-4" id="successMessage"></p>
        <button onclick="closeSuccessModal()"
            class="px-6 py-2 bg-black text-white rounded-md text-sm hover:bg-gray-800">
            Got it
        </button>
    </div>
</div>

<style>
    /* Resume styling to mimic PDF */
    body {
        background-color: #f3f4f6;
    }

    #latex-content {
        font-family: "Times New Roman", serif;
        line-height: 1.2;
    }

    /* Headings like LaTeX sections */
    #latex-content h1,
    #latex-content h2,
    #latex-content h3,
    #latex-content h4,
    #latex-content h5,
    #latex-content h6 {
        margin: 0.5rem 0 0.25rem;
        font-weight: bold;
    }

    #latex-content h1 {
        font-size: 24px;
        border-bottom: 1px solid black;
        padding-bottom: 4px;
    }

    #latex-content h2 {
        font-size: 20px;
        border-bottom: 1px solid #666;
        padding-bottom: 2px;
    }

    #latex-content h3 {
        font-size: 18px;
    }

    /* Lists */
    #latex-content ul,
    #latex-content ol {
        margin: 0.25rem 0 0.5rem 1.25rem;
        padding: 0;
    }

    #latex-content li {
        margin-bottom: 0.25rem;
    }

    /* Subheadings (job / education) - from latex_to_html_with_flex */
    #latex-content .resume-subheading-wrapper {
        margin-bottom: 0.5rem;
    }

    #latex-content .resume-subheading {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.1rem;
    }

    #latex-content .job-title {
        font-weight: normal;
        font-style: italic;
    }

    #latex-content .company-location {
        font-style: italic;
    }

    /* Hyperlinks */
    #latex-content a {
        color: black;
        text-decoration: none;
    }

    /* Checkbox wrapper styling */
    .checkbox-wrapper {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.15s;
    }

    .checkbox-wrapper:hover {
        background-color: #f0f9ff;
    }

    .checkbox-wrapper.selected {
        background-color: #dbeafe;
    }

    .checkbox-wrapper input[type="checkbox"] {
        margin-top: 0.25rem;
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
        cursor: pointer;
    }

    /* Make sure wrapped content maintains proper styling */
    .checkbox-wrapper>*:not(input) {
        flex: 1;
    }

    /* Preserve resume-subheading styling when wrapped */
    .checkbox-wrapper .resume-subheading {
        display: flex;
        justify-content: space-between;
        width: 100%;
    }
</style>

<script>
    const resumeId = '{{ resume_id }}';
    let resumeStructure = null;
    let selectiveEnabled = false;
    let selectedItems = new Set();

    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch(`/resume/${resumeId}/preferences/get`);
            const data = await response.json();

            if (data.success) {
                const prefs = data.preferences;
                selectiveEnabled = prefs.enabled || false;
                document.getElementById('enableSelective').checked = selectiveEnabled;
                updateStatusDisplay();
            }
        } catch (error) {
            console.error('Error loading preferences:', error);
        }
    });

    function toggleSelective(enabled) {
        selectiveEnabled = enabled;
        updateStatusDisplay();

        if (enabled && !resumeStructure) {
            alert('Please load resume preview first');
            document.getElementById('enableSelective').checked = false;
            selectiveEnabled = false;
        }
    }

    function updateStatusDisplay() {
        const statusDisplay = document.getElementById('statusDisplay');

        if (selectiveEnabled) {
            statusDisplay.classList.remove('hidden');
            updateCounts();
        } else {
            statusDisplay.classList.add('hidden');
        }

        document.getElementById('saveBtn').disabled = !selectiveEnabled;
    }

    function updateCounts() {
        document.getElementById('itemCount').textContent = selectedItems.size;
    }

    async function loadResume() {
        document.getElementById('resumeLoading').innerHTML = `
            <svg class="animate-spin h-8 w-8 text-gray-400 mx-auto mb-3" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-gray-600">Loading resume preview...</p>
        `;

        try {
            const response = await fetch(`/resume/${resumeId}/html-preview`);
            const data = await response.json();

            if (data.success) {
                resumeStructure = data.structure;
                document.getElementById('latex-content').innerHTML = data.html;

                // Wrap items with checkboxes
                wrapItemsWithCheckboxes();

                document.getElementById('resumeLoading').classList.add('hidden');
                document.getElementById('resumePreview').classList.remove('hidden');
                enableButtons();
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error loading resume: ' + error.message);
        }
    }


    function wrapItemsWithCheckboxes() {
        const content = document.getElementById('latex-content');

        // Select:
        // 1. All paragraphs (regular content)
        // 2. All list items (bullet points)
        // 3. All .resume-subheading divs (job headers created by latex_to_html_with_flex)
        const items = content.querySelectorAll('p');

        let index = 0;

        items.forEach((item) => {
            // Skip if already wrapped
            if (item.closest('.checkbox-wrapper')) return;

            // Create wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'flex gap-3 items-start p-2 rounded hover:bg-gray-50 checkbox-wrapper';
            wrapper.setAttribute('data-item-index', index);

            // Create checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'mt-1';
            checkbox.id = `item_${index}`;

            // Add change event
            checkbox.addEventListener('change', (e) => {
                const itemIndex = parseInt(wrapper.getAttribute('data-item-index'));

                if (e.target.checked) {
                    selectedItems.add(itemIndex);
                    wrapper.classList.add('bg-blue-50');
                    console.log('Selected:', item.innerText.trim());
                } else {
                    selectedItems.delete(itemIndex);
                    wrapper.classList.remove('bg-blue-50');
                }

                updateCounts();
            });

            // Append checkbox and cloned content
            wrapper.appendChild(checkbox);
            wrapper.appendChild(item.cloneNode(true));
            item.replaceWith(wrapper);

            index++;
        });
    }

    function enableButtons() {
        document.getElementById('selectAllBtn').disabled = false;
        document.getElementById('deselectAllBtn').disabled = false;
    }

    function selectAll() {
        document.querySelectorAll('.checkbox-wrapper input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = true;
            const wrapper = checkbox.closest('.checkbox-wrapper');
            const itemIndex = parseInt(wrapper.getAttribute('data-item-index'));
            selectedItems.add(itemIndex);
            wrapper.classList.add('bg-blue-50');
        });
        updateCounts();
    }

    function deselectAll() {
        document.querySelectorAll('.checkbox-wrapper input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
            const wrapper = checkbox.closest('.checkbox-wrapper');
            const itemIndex = parseInt(wrapper.getAttribute('data-item-index'));
            selectedItems.delete(itemIndex);
            wrapper.classList.remove('bg-blue-50');
        });
        updateCounts();
    }

    async function savePreferences() {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        try {
            const selections = mapSelectedItemsToStructure();

            const response = await fetch(`/resume/${resumeId}/preferences`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    enabled: selectiveEnabled,
                    sections: selections
                })
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('successMessage').textContent =
                    `Saved ${selectedItems.size} selected items for AI regeneration.`;
                document.getElementById('successModal').classList.remove('hidden');
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error saving: ' + error.message);
        } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = 'Save Preferences';
        }
    }




    function mapSelectedItemsToStructure() {
        const sectionsMap = {};

        document.querySelectorAll('.checkbox-wrapper input[type="checkbox"]').forEach((checkbox) => {
            if (!checkbox.checked) return;

            const wrapper = checkbox.closest('.checkbox-wrapper');
            const sectionId = wrapper.getAttribute('data-section-id');
            const subsectionId = wrapper.getAttribute('data-subsection-id');
            const itemContent = wrapper.querySelector('p').innerText.trim();

            if (!sectionsMap[sectionId]) {
                // Find section from resumeStructure
                const section = resumeStructure.find(s => s.section_id === sectionId);
                if (!section) {
                    console.warn('Section not found for ID:', sectionId);
                    return; // skip this checkbox
                }
                sectionsMap[sectionId] = {
                    section_id: section.section_id,
                    section_type: section.section_type,
                    title: section.title,
                    selected: true,
                    subsections: {}
                };
            }

            if (!sectionsMap[sectionId].subsections[subsectionId]) {
                const subsection = resumeStructure
                    .find(s => s.section_id === sectionId)
                    .subsections.find(ss => ss.id === subsectionId);

                sectionsMap[sectionId].subsections[subsectionId] = {
                    id: subsection.id,
                    title: subsection.title,
                    selected: true,
                    items: []
                };
            }

            sectionsMap[sectionId].subsections[subsectionId].items.push(itemContent);
        });

        // Convert subsections object to array
        const sectionsArray = Object.values(sectionsMap).map(section => {
            section.subsections = Object.values(section.subsections);
            return section;
        });

        return sectionsArray;
    }




    function closeSuccessModal() {
        document.getElementById('successModal').classList.add('hidden');
    }
</script>

{% endblock %}